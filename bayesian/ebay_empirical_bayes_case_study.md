# A Case Study in Empirical Bayes

이베이에서 특정 키워드로 검색했을 때 상품들의 순서를 어떻게 결정할 수 있을까? 한 가지 좋은 방법은 과거의 인기도를 가지고 나열하는 것이다. 
인기도를 계산하는 방법은 여러 가지가 있겠지만, 노출수 대비 판매량 비율 (S/I : Sales / Impressions) 을 통해 계산해 볼 수 있다.
앞으로 이야기할 것들은 비율로 표현되는 수치라면 같은 방식으로 적용할 수 있다.

## 문제

위와 같은 계산 방식을 사용할 경우, 문제는 분모가 작을 때 발생한다. 일반적인 상품이 100번 노출되면 1번 꼴로 판매된다고 가정해보자.
그런데 우연히 세번째 노출에 판매되어버렸다. 이제 S/I 는 1/3이다. 
수치만 봐서는 엄청나게 인기있는 상품일 것 같지만, 아직 세 번 밖에 노출되지 않은 상품이라는 것을 명심해야 한다. 

한 가지 해결방법은 S/I와 I 를 모두 제공하는 것이다. 그리고 노출이 적을 경우 S/I 값을 얼마나 보정해야 할지 결정해야 한다. 
하지만 그런 작업이 필요없다는 것을 알게 될 것이다. 심지어 노출이 적을 때도 의미있는 값을 도출할 수 있다.

## 해결방법

잠깐 맨 끝에 정리된 수식을 보면 (S + a) / (I + b) 이라고 되어 있다. 이 값은 노출수가 많아질수록 S/I에 가까워진다. 
또, 기본값은 a/b 라는 것을 알 수 있다. S = I = 0 일 때의 상황이다. 

이제 이 글의 나머지 부분에서는 다음 두 가지 내용에 대해 살펴볼 것이다

1. a와 b 값을 어떻게 결정할 것인가?
2. (S + a) / (I + b) 라는 식은 어떻게 도출된 것인가?

만약 Laplace Smoothing을 알고 있다면, 위의 수식은 그 일반화된 형태라고 생각하면 된다. 
하지만 여전히 의문이 존재한다. 왜 weighted sum이 아니라 저런 형태가 되는 걸까?

### (S + a) / (I + b) 는 어디서 온 것일까?

(S + a) / (I + b) 라는 것은 S/I 값 대신 매 노출마다 판매될 확률의 예측치를 반환하는 것이다. 조금 더 구체적으로 살펴보자.

상품이 판매될 확률이 p로 고정되어 있다고 가정해보자. 이제 n개의 노출에서 k개의 상품이 팔릴 확률은 다음과 같다.

```
Pr(상품 k개 판매) = nCk * p^k * (1-p)^(n-k)

n: 노출수
k: 판매된 상품 수
```

이제 위 모형을 테스트하기 위해, 두 가지 데이터를 비교해보았다. 

* 첫 번째 데이터는 과거의 상품 판매정보이다. 이미 관측된 n, k 값을 사용한다. 
* 두 번째는 과거의 노출수 n 값에 대해 k 값을 위 식을 통해 랜덤하게 생성한다.

두 가지 데이터를 비교해보면 아래 그래프가 나온다. 분포가 정말 다르다는 것을 바로 알 수 있다.

![png](https://www.ebayinc.com/assets/Uploads/Blog/2015/01/plot1.png)

조금 더 복잡한 모형을 고려해야 할 것 같다. 
확률 p가 고정되어 있는 것이 아니라, 특정한 확률 분포를 따른다고 가정해보자. 
그리고 여기서 구한 p값을 이전의 수식에 반영하여 k을 구하고 분포를 살펴보면, 전보다는 더 실제와 비슷한 분포를 얻을 수 있다.

![png](https://www.ebayinc.com/assets/Uploads/Blog/2015/01/plot2.png)
